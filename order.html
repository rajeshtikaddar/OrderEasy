<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Your Order</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      padding: 20px;
    }
    h2, h3 { text-align: center; color: #8a24e4; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }
    th { background: #8a24e4; color: white; }
    .qr-section, .btn-section {
      text-align: center;
      margin-top: 30px;
    }
    .qr-section canvas {
      margin-top: 10px;
      width: 220px !important;
      height: 220px !important;
    }
    button {
      padding: 12px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      background: #8a24e4;
      color: white;
      transition: background 0.3s;
    }
    button:hover { background: #6e1bc1; }
  </style>
</head>
<body>
  <h2>Your Selected Items</h2>
  <table id="orderTable">
    <thead>
      <tr>
        <th>Dish</th>
        <th>Price (₹)</th>
        <th>Quantity</th>
        <th>Subtotal</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
  <h3 id="total"></h3>

  <!-- ✅ UPI Payment QR -->
  <div class="qr-section">
    <h2>Pay via UPI</h2>
    <canvas id="upiQr"></canvas>
    <p id="upiText"></p>
  </div>

  <!-- ✅ Payment Done Button -->
  <div class="btn-section">
    <button id="paymentDoneBtn">Payment Done</button>
    <br><br>
    <button id="downloadBtn" style="display:none;">Download Invoice</button>
  </div>

  <!-- QR + PDF libraries -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

  <script>
    let cartItems = [];
    let total = 0;

    function getQueryParam(param) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(param);
    }

    const data = getQueryParam("data");
    if (data) {
      try {
        cartItems = JSON.parse(atob(data));
        const tbody = document.querySelector("#orderTable tbody");
        total = 0;

        cartItems.forEach(item => {
          const subtotal = item.price * item.qty;
          total += subtotal;
          tbody.innerHTML += `
            <tr>
              <td>${item.name}</td>
              <td>₹${item.price}</td>
              <td>${item.qty}</td>
              <td>₹${subtotal}</td>
            </tr>
          `;
        });

        document.getElementById("total").innerText = "Total: ₹" + total;

        // ✅ Generate UPI QR
        const upiId = "9733811590@fam"; // replace with your UPI ID
        const name = "OrderEasy";
        const upiUrl = `upi://pay?pa=${upiId}&pn=${encodeURIComponent(name)}&am=${total}&cu=INR`;

        QRCode.toCanvas(document.getElementById("upiQr"), upiUrl, function (error) {
          if (error) console.error(error);
        });

        document.getElementById("upiText").innerText =
          `Scan & Pay ₹${total} to ${upiId}`;

      } catch (e) {
        document.body.innerHTML = "<p style='color:red;'>Invalid order data</p>";
      }
    } else {
      document.body.innerHTML = "<p style='color:red;'>No order data found</p>";
    }

    // ✅ Handle Payment Done -> Show Download Button
    document.getElementById("paymentDoneBtn").addEventListener("click", () => {
      document.getElementById("downloadBtn").style.display = "inline-block";
      alert("Payment confirmed! You can now download your invoice.");
    });

    // ✅ Generate PDF Invoice
    document.getElementById("downloadBtn").addEventListener("click", () => {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // Header
      doc.setFontSize(20);
      doc.text("OrderEasy", 105, 20, { align: "center" });
      doc.setFontSize(12);
      doc.text("Invoice", 105, 28, { align: "center" });
      doc.text("Date: " + new Date().toLocaleString(), 14, 40);

      // Table of items
      const tableData = cartItems.map(item => [
        item.name,
        "₹" + item.price,
        item.qty,
        "₹" + (item.price * item.qty)
      ]);

      doc.autoTable({
        head: [["Dish", "Price", "Qty", "Subtotal"]],
        body: tableData,
        startY: 50,
      });

      // Total
      const finalY = doc.lastAutoTable.finalY + 10;
      doc.setFontSize(14);
      doc.text("Total: ₹" + total, 14, finalY);

      // Save file
      doc.save("OrderEasy_Invoice.pdf");
    });
  </script>
</body>
</html>
